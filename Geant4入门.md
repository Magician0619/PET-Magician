[@TOC]

Geant4入门

![Bench3](https://gitee.com/magician0619/picgo/raw/master/PET/20201018180641.jpg)

# 一、Geant4简介

Geant4，是模拟辐射粒子与物质相互作用的可靠软件工具，有着丰富的物理过程截面库，涉及中子、伽玛（X）、电子、质子、各种重离子乃至可衰变核素等各种辐射粒子。Geant4物理模拟的初衷在于仿照真实的物理实验场景，通过各种物理反应过程截面的蒙特卡罗抽样来模拟真实的物理过程。

模拟的意义在于通过计算机平台工具去模仿真实的物理实际场景，我们在做实验的时候想得到怎样的信息，那么我们同样想在Geant4中得到同样的信息。在Geant4模拟中，最需要用户费心思的地方多在于所感兴趣的物理信息抽取与统计，在实验场景中，电子学信号的读出同样也是最复杂的那部分。

## 1、Geant4基本功能

Geant4(Geometry and Tracking)由欧洲核子中心(CERN)于1994年开发，是一个以C++为底层语言，以蒙特卡罗方法为基础的模拟粒子在材料中的输运过程的工具，对所有用户开放且开源。主要应用领域为高能物理/核物理/加速器物理/核医学。由于其模拟的真实性，它可以提供给用户与真实实验结果相差不大的模拟结果，方便用户在真实实验之前对实验进行评估与修改。

用户在使用时，可以根据自身的需求自行设置输入项与输出项：

**输入项**：粒子源/与粒子发生相互作用的材料/探测器/模拟的粒子的数量等；

**输出项(记录项)**：粒子在与材料相互作用的各项信息，如反应时间/反应轨迹/反应沉积能量等。

通过自行设置输入项与输出项，用户可以做到对实验方案进行预先的模拟以及对模拟结果进行分析。

## 2、Geant4模拟说明

在设置好上述的输入项与输出项之后，Geant4就会根据用户的设置来进行模拟。

①Geant4读取用户设置的粒子源项，包括粒子的种类/能量，粒子源的位置/发射粒子的方向等；

②Geant4读取用户设置的材料相关的项，包括材料的种类/形状/位置等。

在成功读取并且没有错误的情况下，Geant4中的粒子源会发射一个指定的粒子，该粒子会与用户设置的材料进行相互作用，其相互作用的种类/沉积能量/作用时间等属性由蒙特卡洛抽样来决定，而进行抽样基于的概率来自于Geant4自带的粒子与材料相互作用的数据库，这些数据库有些是实验测量的结果，有些是理论计算的结果。

常用的数据库链接：[https://link.zhihu.com/?target=https%3A//www-nds.iaea.org/exfor/endf.htm](https://link.zhihu.com/?target=https%3A//www-nds.iaea.org/exfor/endf.htm)

- 一个粒子从发射到与材料进行相互作用再到最后沉积到材料内部进入稳定状态或者是飞出本次模拟的几何范围是一个粒子的生命周期，为一个事例，在Geant4中被称为"Event"。

- 粒子与材料进行的相互作用可能因为次级粒子的产生而有多条轨迹，如光子与材料相互作用，产生的次级粒子包括电子，这个电子将继续与材料进行相互作用而产生一条轨迹。在Geant4中，每个粒子或者是次级粒子在材料中行进的轨迹，被称为"Track"。

- 需要说明的是，粒子与材料进行的相互作用可能有多次；因此Geant4以每个Track上发生的相互作用为节点，把每个Track都分为了若干个步，在Geant4中被称为"Step"，每一个Step代表着粒子与材料发生了一次相互作用。一般来说，输出项中大部分信息都以Step为单位进行记录，记录的是本次相互作用发生的时间/位置/沉积能量等信息。

![v2-ff9e93b9e1539f2b30cd0aae1f68e66b_720w](https://gitee.com/magician0619/picgo/raw/master/PET/20201018181604.jpg)

## 3、Geant4模拟架构

Geant4的一次模拟称为一个"Run"，在Run之前，用户需要设置好上述的所有输入项与输出项，在Run开始之后，除了打断当前的Run，用户无法对Run进行任何的干预。

用户可以自行设置每个Run要模拟的粒子的数量，即上文所述的事例的数目，简称为事例数。综上所述，一个Run由若干个Event构成，一个Event由若干条Track构成，一条Track由若干个Step构成。

当Geant4程序模拟完成了指定的事例数时，程序结束运行，并给出用户指定的输出信息。输出信息可以以用户指定类型的记录文件(如.txt/.csv等)为载体，也可以出现在Geant4的用户交互界面中。

# 二、基础示例

## BASIC--B1

示例B1是关于医用、辐射剂量评估的模拟。物理几何模型如下图所示：半透明蓝色方盒子填充为水，内部的两个体积分别填充了人体组织和骨骼的材料。射线源，即仿照拍摄X光片或者质子（重离子）治疗的场景，射线束为平行伽玛射线或者质子束，射线束打向整个方盒子。最终为了计算在入射多个（比如100个）射线/粒子后，骨骼材质的棱台所吸收的剂量是多少。

![QQ图片20201018182027](https://gitee.com/magician0619/picgo/raw/master/PET/20201018182041.png)



统计计算几何体Shape2吸收剂量的过程的核心在于：抽取Step中所感兴趣的信息，即判断当前Step是否在Shape2中，如果在，并且沉积能量大于0，则将沉积能量累加给当前Event的一个统计变量A，在当前Event结束时，再将A统计给当前Run，在当前Run结束时，通过计算总沉积能量与Shape2的质量比值来得到吸收剂量。



![16420607-4bb75c6d4bfbbffc](https://gitee.com/magician0619/picgo/raw/master/PET/20201018175321.png)

B1的物理过程列表用的是集成好的QBBC，包含了标准电磁相互作用过程和强子物理过程，只需要在主函数exampleB1.cc中声明调用即可。在定义好几何体之后，当有辐射粒子穿过几何体时，Geant4会根据辐射粒子的特性和几何体材料的特性进行物理过程的蒙卡抽样，通过Step给出所可能发生的物理过程。

Geant4最需要注意的地方在于根据用户的需求获得想要的信息，B1是想获得入射N个粒子后，Shape2获得多少剂量。获取信息，离不开SteppingAction.cc，step即G4Step，会给出几乎所有真实实验中可以给出的信息。

计算剂量，我们需要知道：

> a. 每个粒子即Event会沉积多少能量，然后把所有粒子/Event的沉积能量相加，所有的沉积能量/Shape2质量=剂量；
>
> b. 每个粒子与几何体相互作用时，Shape2中的每个Step沉积多少能量，然后把这些Step沉积能量相加给当前的Event。

在Geant4模拟中，我们通常是从小到大来获取统计这些能量信息：

> a. 询问当前Step所处的位置是否属于Shape2几何体内，如果是，沉积能量edep相加给当前Event中的一个中间变量fEdep（在每个Event开始时，该变量fEdep初始化为0，用来统计当前Event下所有Step的沉积能量和）。
>
> b. 在每个Event开始时，变量fEdep初始化为0，在结束时，将fEdep相加给Run中的变量“fEdep”，在Run结束时，当前所有入射粒子总的沉积能量也就得出来了。

通过在命令行中输入指令可以对粒子进行控制

```bash
/control/verbose 2
/tracking/verbose 1
/run/beamOn 10 
```



![img](https://gitee.com/magician0619/picgo/raw/master/PET/20201018190846.png)

或者直接输入

```bash
exampleB1 run2.mac
```



![gif](https://gitee.com/magician0619/picgo/raw/master/PET/20201018192340.gif)

# Cylindrical PET

Cylindrical PET是基于圆柱几何体，包含5个level，从mother到daughter，定义如下：

- **world** **cylindrical PET 世界圆柱**.

- **rsector** (depth=1)一个箱子, 在cylindricalPET里面用环重复.

- **module** (depth=2)*rsector里面的箱子*. *用cubicarray repeater* 重复，没有x方向的重复。这个是可选项

- **submodule**(depth=3) *module里面的箱子*. *cubicarray repeater* 重复，没有x方向的重复。这个是可选项

- **crystal** (depth=4) *submodule里的箱子*.*cubicarray repeater* 重复，没有x方向的重复。这个是可选项

- layer

   

  (depth=5)

   

  crystal里面的径向箱子

  . 不能用repeater，而应该在macro文件中一个一个建立.

   

  layer必须用下面命令设置为合理

  ```html
  /attachCrystalSD
  ```

参考链接：

1、[Geant4 基础1——简介](https://zhuanlan.zhihu.com/p/137384340)